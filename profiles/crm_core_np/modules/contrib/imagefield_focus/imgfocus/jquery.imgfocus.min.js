
/**
 * @file
 * Written by Henri MEDOT <henri.medot[AT]absyx[DOT]fr>
 * http://www.absyx.fr
 *
 * Released under the GPLv2 license.
 */

(function(h){var k=function(a,b,c,d){a=a||0;if(a.pop){b=a[1];c=a[2];d=a[3];a=a[0]}this.x=a||0;this.y=b||0;this.width=c||0;this.height=d||0};h.extend(k,{MAP:[9,8,12,4,6,2,3,1],T:8,R:4,B:2,L:1});h.extend(k.prototype,{top:function(a){if(a!==undefined){this.height-=a-this.y;this.y=a;return this}return this.y},right:function(a){if(a!==undefined){this.width=a-this.x;return this}return this.x+this.width},bottom:function(a){if(a!==undefined){this.height=a-this.y;return this}return this.y+this.height},left:function(a){if(a!==
undefined){this.width-=a-this.x;this.x=a;return this}return this.x},location:function(a,b){if(a!==undefined){if(a.pop){b=a[1];a=a[0]}this.x=a;this.y=b;return this}return[this.x,this.y]},size:function(a,b){if(a!==undefined){if(a.pop){b=a[1];a=a[0]}this.width=a;this.height=b;return this}return[this.width,this.height]},scale:function(a,b){if(a.pop){b=a[1];a=a[0]}this.x*=a;this.y*=b;this.width*=a;this.height*=b;return this},intersection:function(a){this.left(Math.max(this.x,a.x));this.top(Math.max(this.y,
a.y));this.right(Math.min(this.right(),a.right()));this.bottom(Math.min(this.bottom(),a.bottom()));return this},union:function(a){this.left(Math.min(this.x,a.x));this.top(Math.min(this.y,a.y));this.right(Math.max(this.right(),a.right()));this.bottom(Math.max(this.bottom(),a.bottom()));return this},equals:function(a){return this.x==a.x&&this.y==a.y&&this.width==a.width&&this.height==a.height},contains:function(a){return this.union(a).equals(this)},setRect:function(a){this.x=a.x;this.y=a.y;this.width=
a.width;this.height=a.height;return this},clone:function(){return new k(this.x,this.y,this.width,this.height)},toArray:function(){return[this.x,this.y,this.width,this.height]},toCss:function(){var a=this.clone().round();return"rect("+a.y+"px "+(a.right()-1)+"px "+(a.bottom()-1)+"px "+a.x+"px)"},round:function(){var a=Math.round(this.right()),b=Math.round(this.bottom());this.x=Math.round(this.x);this.y=Math.round(this.y);return this.right(a).bottom(b)},isEmpty:function(){return this.width<=0||this.height<=
0},ifEmpty:function(a){return this.isEmpty()?this.setRect(a):this},applyTo:function(a){var b=this.clone().round();a.css({left:b.x,top:b.y}).width(b.width).height(b.height);return this},ratio:function(a,b){var c,d,e=k.MAP[b||0];if(a>1){c=Math.min(this.width,this.height*a);d=c/a}else{d=Math.min(this.height,this.width/a);c=d*a}if(e&k.R)this.x=this.right()-c;if(e&k.B)this.y=this.bottom()-d;this.width=c;this.height=d;return this},constraint:function(a){if(a.moveOnly){a.minRect&&this.location(Math.min(this.x,
a.minRect.x),Math.min(this.y,a.minRect.y)).location(Math.max(this.right(),a.minRect.right())-this.width,Math.max(this.bottom(),a.minRect.bottom())-this.height);a.maxRect&&this.location(Math.max(this.x,a.maxRect.x),Math.max(this.y,a.maxRect.y)).location(Math.min(this.right(),a.maxRect.right())-this.width,Math.min(this.bottom(),a.maxRect.bottom())-this.height)}else{var b=a.anchor||0,c=k.MAP[b];if(a.minRect){this.union(a.minRect);a.maxSize&&this.intersection((new l(a.minRect.right()-a.maxSize[0],a.minRect.bottom()-
a.maxSize[1])).right(a.minRect.x+a.maxSize[0]).bottom(a.minRect.y+a.maxSize[1]))}var d=this.width,e=this.height;if(a.minSize){d=Math.max(d,a.minSize[0]);e=Math.max(e,a.minSize[1])}if(a.maxSize){d=Math.min(d,a.maxSize[0]);e=Math.min(e,a.maxSize[1])}if(c&k.R)this.left(this.right()-d);else this.width=d;if(c&k.B)this.top(this.bottom()-e);else this.height=e;if(a.maxRect){a.minSize&&this.location(Math.max(this.x,a.maxRect.x+a.minSize[0]-this.width),Math.max(this.y,a.maxRect.y+a.minSize[1]-this.height)).location(Math.min(this.x,
a.maxRect.right()-a.minSize[0]),Math.min(this.y,a.maxRect.bottom()-a.minSize[1]));this.intersection(a.maxRect)}a.ratio&&this.ratio(a.ratio,b)}return this}});var l=k,p,q,n=function(){return h("<div></div>")},o=function(a){a.stopPropagation();a.preventDefault();return false},r=function(a,b,c){var d=b.offset();if(c){d.left+=b.width()/2;d.top+=b.height()/2}return[a.pageX-d.left,a.pageY-d.top]},s=function(a,b){for(var c=n().addClass("imgfocus-box imgfocus-"+a).appendTo(b).hide(),d=0;d<4;d++)n().addClass("imgfocus-border imgfocus-border-"+
d).appendTo(c);return c},t=function(a){a?q.css("cursor",a.css("cursor")).addClass("imgfocus-cursor"):q.css("cursor","auto").removeClass("imgfocus-cursor")},w={point:function(a){return r(a,this.wrapper)},unbindAll:function(){this.targets.unbind(".imgfocus");return this},setIdle:function(){var a=this.unbindAll();a.oldSelRect=a.selRect?a.selRect.clone():null;t();a.wrapper.bind("mousedown.imgfocus",function(b){var c=a.point(b);a.selRect=(new l(c[0],c[1],1,1)).constraint(a.constraints());a.repaint().setResize(4,
[0,0]);return o(b)});h.each(a.handles,function(b){(function(c,d,e){d.bind("mousedown.imgfocus",function(g){var i=r(g,d,true);c.setResize(e,i);return o(g)})})(a,h(this),b)});a.handle8.bind("mousedown.imgfocus",function(b){var c=r(b,a.handle8);a.setMove(c);return o(b)});return a},setResize:function(a,b){var c=this.unbindAll(),d=l.MAP[a],e=c.constraints((a+4)%8);t(c.handles[a]);p.bind("mousemove.imgfocus",function(g){var i=c.point(g);i[0]-=b[0];i[1]-=b[1];if(d&l.L)c.selRect.left(i[0]);else d&l.R&&c.selRect.right(i[0]);
if(d&l.T)c.selRect.top(i[1]);else d&l.B&&c.selRect.bottom(i[1]);c.selRect.constraint(e);c.repaint();return o(g)});return c.addMouseup()},setMove:function(a){var b=this.unbindAll(),c=b.constraints(true);t(b.handle8);p.bind("mousemove.imgfocus",function(d){var e=b.point(d);e[0]-=a[0];e[1]-=a[1];b.selRect.location(e).constraint(c);b.repaint();return o(d)});return b.addMouseup()},addMouseup:function(){var a=this;p.bind("mouseup.imgfocus",function(b){if(!a.oldSelRect||!a.selRect.equals(a.oldSelRect))a.$this.trigger("change");
a.setIdle();return o(b)});return a},constraints:function(a){var b=this.rules;if(a===true){b.moveOnly=true;b.anchor=0}else{b.moveOnly=false;b.anchor=a||0}return b},repaint:function(){var a=this.selRect;if(a&&!a.isEmpty()){a.applyTo(this.selBox.show());this.clipBox.show().css("clip",a.toCss())}else{this.selBox.hide();this.clipBox.hide()}return this},getSel:function(){return this.selRect?this.selRect.clone().scale(1/this.scale[0],1/this.scale[1]).round().constraint({minSize:[1,1]}).toArray():null},setSel:function(a){this.selRect=
a?(new k(a)).scale(this.scale).constraint(this.constraints()):null;return this.repaint().setIdle()}},u={_init:function(a){if(!p){p=h(document);q=h("html")}return this.each(function(){var b=h(this),c=b.data("imgfocus");if(!c){c=[b.width(),b.height()];var d=n().addClass("imgfocus-wrapper"),e=h("<img />").addClass("imgfocus-img").attr("src",b.attr("src")).appendTo(d);e=n().addClass("imgfocus-box imgfocus-clipbox").appendTo(d).append(e.clone()).hide();for(var g=s("minbox",d),i=s("maxbox",d),f=s("selbox",
d),j=[],m=0;m<8;m++)j[m]=n().addClass("imgfocus-resize imgfocus-handle imgfocus-handle-"+m).addClass(m%2==0?"imgfocus-resize-corner":"imgfocus-resize-side").appendTo(f);m=n().addClass("imgfocus-move imgfocus-handle").prependTo(f);var v=d.find(".imgfocus-handle").andSelf().add(document);d.insertAfter(b.hide());c=h.extend({$this:b,size:c,wrapper:d,clipBox:e,minBox:g,maxBox:i,selBox:f,handles:j,handle8:m,targets:v,sides:v.filter(".imgfocus-resize-side"),selRect:null,options:{}},w);b.data("imgfocus",
c)}b.imgfocus("options",a)})},options:function(a){a=a||{};return this.each(function(){var b=h(this).data("imgfocus"),c=h.extend(b.options,a),d=b.size,e=c.boxSize||[d[0],d[1]],g=c.realSize||[d[0],d[1]];e.pop||(e=[e,e]);e=(new l(0,0,e[0],e[1])).ratio(g[0]/g[1]);var i=e.clone();d=[e.width,e.height];g=b.scale=[d[0]/g[0],d[1]/g[1]];var f={};f.maxRect=e=(new l(c.maxRect)).scale(g).intersection(e).ifEmpty(e);f.maxSize=c.maxSize?[Math.max(0,Math.min(e.width,c.maxSize[0]*g[0])),Math.max(0,Math.min(e.height,
c.maxSize[1]*g[1]))]:[e.width,e.height];f.minRect=(new l(c.minRect)).scale(g).intersection(e);var j=f.minRect.size();if(f.minRect.isEmpty()){f.minRect=null;j=[0,0]}f.minSize=j=c.minSize?[Math.min(e.width,Math.max(j[0],c.minSize[0]*g[0])),Math.min(e.height,Math.max(j[1],c.minSize[1]*g[1]))]:j;f.ratio=c.ratio&&!f.minRect?j[0]>0&&j[1]>0?j[0]/j[1]:c.ratio*g[0]/g[1]:0;f.minSize=[Math.max(f.minSize[0],1),Math.max(f.minSize[1],1)];b.rules=f;b.wrapper.width(d[0]).height(d[1]);f.maxRect.equals(i)?b.maxBox.hide():
f.maxRect.applyTo(b.maxBox.show());f.minRect?f.minRect.applyTo(b.minBox.show()):b.minBox.hide();f.ratio?b.sides.hide():b.sides.show();b.selRect&&b.selRect.constraint(b.constraints());b.repaint().setIdle()})},selection:function(a){return a===undefined?this.data("imgfocus").getSel():this.each(function(){h(this).data("imgfocus").setSel(a)})}};h.fn.imgfocus=function(a){if(u[a])return u[a].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof a=="object"||!a)return u._init.apply(this,arguments);
else throw"Method "+a+" does not exist on jQuery.imgfocus.";}})(jQuery);